---
title: "Hanabi is NP-Complete? (1) Hanabi와 Solitaire Hanabi"
date: 2021-02-07 22:30
categories:
  - study
tags:
  - CS
  - 보드게임
---

저를 아는 사람들은 대부분 아는 사실이겠지만, 저는 보드게임을 굉장히 좋아합니다. 본가에도 책꽂이 두 줄을 할애해가며 보드게임을 전시해뒀죠. 그러던 와중, [^1]을 발견했습니다. 하나비가 NP-Complete라고요? [hanabi.cards](https://hanabi.cards)와 같은 하나비 인공지능이 존재하니 [^2]와 같은 논문이 존재는 하겠구나 했지만, 자신의 패를 보지 못하는 상황에서의 NP-Completeness를 논한다는 것 자체를 생각하지 못했습니다.

이 글에서는 [^1]에 대해 분석해보고자 합니다. 먼저 이 글에서는 Hanabi의 룰과 변형룰에 대해 다루고, Solitaire Hanabi 문제의 Specification에 대해 정리해보고자 합니다.[^a]

# Hanabi의 규칙

Hanabi는 플레이어들이 협동하여 불꽃놀이를 완성하는 게임입니다. 빨강, 노랑, 초록, 파랑, 흰색 다섯 가지 불꽃놀이를 모두 힘을 합쳐 만들어야 하죠. 하지만 여느 협동게임이 그렇듯, 이 게임에는 반전이 있습니다: 바로, 자신의 카드를 자신만 볼 수 없다는 것이죠.

불꽃놀이는 50장의 카드로 표현됩니다. 다섯 가지 색의 불꽃들은 기본적으로 1 세 장, 2~4 두 장, 5 한 장으로 구성되어 있습니다.

플레이어들은 게임이 시작할 때, 불꽃놀이 카드들을 잘 섞어 2~3인일 때에는 5장, 4~5인일 때는 4장의 카드를 가지고 시작합니다. 그리고, 앞면을 다른 사람들만 볼 수 있도록 듭니다. 또한 8개의 힌트 토큰을 앞면으로 두고, 3개의 퓨즈 토큰을 뒷면으로 둡니다.

가장 다채로운 옷을 입은, 또는 가장 최근에 불꽃놀이를 본[^b] 플레이어부터 돌아가며, 자신의 턴에 다음 중 한 가지 액션만을 할 수 있습니다:

1. 힌트 주기

   앞면인 힌트 토큰 하나를 뒤집고, 다른 플레이어에게 그 사람의 손패에 대한 힌트를 줍니다. 힌트를 줄 때에는 숫자 또는 색에 대한 힌트를 줄 수 있으며, 힌트를 줄 때에는 해당 속성에 해당하는 *모든* 카드에 대해 알려주어야 합니다. 모든 힌트 토큰이 뒷면이라면 힌트를 줄 수 없습니다.

   예를 들어, 손패가 순서대로:

   ​	`초록 2` `초록 3` `노랑 1` `초록 2` `노랑 3`

   인 경우, "초록"을 힌트로 주는 경우 1/2/4번째 카드를, "3"을 힌트로 주는 경우 2/5번째 카드를 알려주어야 합니다. 이 중 일부만 알려줄 수는 없습니다.

2. 카드 버리기

   손패로 가지고 있는 카드 한 장을 공개하여 버리고, 뒷면인 힌트 토큰이 있다면 하나를 뒤집습니다. 그 후, 카드를 한 장 다시 뽑아옵니다.

   버린 카드들은 항상 확인할 수 있습니다.

3. 카드 플레이하기

   카드를 플레이합니다. 플레이한 카드가 불꽃놀이에 추가될 수 있다면 추가되지만, 추가할 수 없다면 퓨즈가 터져, 뒷면인 퓨즈 토큰 하나를 뒤집고 카드는 버려집니다. 퓨즈 토큰 3개가 모두 뒷면이 되면 그 즉시 0점으로 게임이 종료됩니다. 만약 어떤 색이든 5 카드를 성공적으로 냈다면, 뒷면인 힌트 토큰이 있다면 하나를 뒤집을 수 있습니다!

   카드가 불꽃놀이에 추가될 수 있으려면, 그 카드가 1이면서 해당 색의 카드를 아직 낸 적이 없거나, 그 카드와 같은 색의 카드를 냈으면서 그 카드보다 1 작은 카드를 냈어야 합니다. 예를 들어 지금까지 플레이된 카드가:

   ​	`빨강 1,2` `노랑 1` `초록 1,2,3,4`

   인 경우, `빨강 3`, `노랑 2`, `초록 5`,  `파랑 1`, `하양 1`을 낼 수 있습니다. 추가로, `초록 5`를 낸다면, 뒷면인 힌트 토큰 하나를 뒤집을 수 있죠.

불꽃 덱이 모두 떨어지면 각자 마지막 한 턴 씩을 가지고, 점수를 계산합니다. 완성에 기여한 불꽃 카드당 1점씩, 최대 총 25점을 획득할 수 있습니다.

[hanabi.cards](https://hanabi.cards)에서 인공지능 봇과, 또는 다른 사람들과 함께 플레이 할 수 있습니다.

## 변형 규칙들

하나비에는 여러 변형 규칙이 있습니다. 간단하게는 퓨즈와 힌트 토큰의 개수를 조절하여 난이도를 조절할 수 있지만, 보다 더 복잡한 난이도 조절도 가능합니다. 비록 논문과 크게 연관은 없겠지만 재밌을 테니 공식 변형 규칙들을 간단하게 소개하고 넘어가도록 하겠습니다.

### 여섯 번째 불꽃(Sixth Firework)

여섯 번째 불꽃을 게임에 추가합니다. 이 불꽃은 여느 색처럼 직접 힌트를 줄 수 있습니다.

### 무지개 불꽃(Rainbow Firework)

무지개 불꽃은 *모든 색*의 불꽃입니다. 하지만 이 색 힌트를 직접 줄 수는 없죠. 다시 말해, 이 불꽃의 색을 알기 위해서는 최소 두 번의 힌트를 주어야 한다는 소리입니다.

### 중요한 불꽃(Critical Firework)

한 색의 불꽃이 1~5까지 딱 한장씩만 존재하는 경우입니다. 보통 룰북에서는 무지개 불꽃을 중요한 불꽃으로 하는 것만을 소개했지만, 다른 색 역시 이렇게 할 수 있을 것입니다.

### 시간(Timed Display)

카드를 플레이할 때 그 카드를 공개하기 전, 이 카드가 어떤 색인지를 말하기로 선택할 수 있습니다.

만약 맞췄고 이 카드가 불꽃놀이에 추가될 수 있었다면, 불꽃놀이에 불꽃이 추가되는 동시에 뒷면인 힌트 토큰 하나를 뒤집을 수 있습니다. 만약 이 카드가 5였다면, 두개를 뒤집을 수 있습니다!

하지만 틀렸다면, 앞면인 퓨즈 하나를 뒤집는 동시에 해당 카드가 추가될 수 있었다 할지라도 버려야 합니다.

### 피날레(Grand Finale)

덱이 떨어진다 할지라도 게임을 계속 할 수 있습니다. 퓨즈 3개가 모두 터지거나 모든 카드를 사용할때까지 플레이합니다. 덱이 떨어졌을때 플레이어들은 카드를 새로 뽑지는 않습니다. 또한, 카드를 다 사용한 플레이어는 힌트 토큰이 없다면 턴을 그냥 넘깁니다.

이 변형 규칙에서는 All-or-nothing을 사용하기도 합니다. 불꽃놀이는 완벽하거나, 아니면 실패하는 거죠.

### 일급 도제(Master Artisan)

5 카드를 플레이함으로서 얻는 이득이 단순히 힌트 토큰 하나에서 더 다채롭게 바뀝니다. 게임이 시작할 때, 여섯 장의 일급 도제 카드를 섞어둡니다. 5 카드를 플레이하는데에 성공하면, 카드 한 장을 뽑아 즉시 적용시킵니다. 여섯 장의 카드는 다음과 같습니다:

- 뒷면인 힌트 토큰을 뒤집습니다.(2장)[^c]
- 버려진 카드 한 장을 선택하여 드로우덱으로 다시 섞어넣습니다.(2장)
- 다른 플레이어 한 명을 골라, 한 카드의 색과 숫자를 모두 말해줍니다.
- 폭발하지 않은 퓨즈를 원하는 만큼 뒤집고, 같은 수의 힌트 토큰을 뒤집습니다.

# Solitaire Hanabi

Hanabi의 NP-completeness를 보이기 위해서 우리는 적당히 일반화하고 변형해야 합니다.

먼저, variable parameter을 정의하겠습니다. 하나비의 카드는 값과 색을 가집니다. 이를 값 $a_i \in \{1,\dots,n\}$과 색 $k_i \in \{1,\dots,c\}$의 쌍인 $(a_i, k_i)$으로 표현합니다. 또, 덱을 $\sigma=((a_1,k_1),\dots,(a_N, k_N))$의 $N$장의 sequence로 표현합니다[^d]. 여기에 추가로, 플레이어가 손패로 들고 있을 수 있는 손패 제한(hand size) $h \in \mathbb{N}$와 한 카드가 덱에 여러번 등장할 수 있는 반복 횟수(multiplicity)인 $r \in \mathbb{N}$을 정의합니다. 예를 들자면, 기본 하나비에서는 $(n,c,N,h,r)=(5,5,50,5,3)$ 입니다.

Solitaire Hanabi에서는 하나비의 코어로 작용하는 "자신의 손패를 볼 수 없다"가 빠집니다. 대신, 매 턴 카드 덱 $\sigma$를 플레이어가 한장씩 볼 수 있습니다. 세 가지 행동 중 "힌트 주기"의 필요성이 없어진 대신, 카드를 손패로 가져오는 "저장" 액션이 추가됩니다. 즉, 액션은 다음과 같이 정의됩니다:

- play: 카드를 플레이합니다.
- discard: 카드를 버립니다.
- store: 카드를 저장합니다.

카드의 플레이 가능 여부의 판정은 동일합니다. $(a_i, k_i)$는 $a_i=1$이고 $k_i$ 색의 카드가 플레이된 적 없거나, $a_i>1$이고 $k_i$ 색의 카드 중 마지막으로 플레이된 카드가 $(a_i-1, k_i)$여야 한다는 것이죠.

Solitaire Hanabi의 목적은 $c$개의 색 각각에 대해 $1$부터 $n$까지의 카드를 모두 내는 것입니다. 이렇게 할 수 있는 액션의 순서를 Winning play sequence라고 합니다.

SOLITAIRE HANABI(또는 HANABI) 문제는 어떤 주어진 $(h, \sigma)$ instance에 대해 Winning play sequence를 찾을 수 있는지에 관한 것입니다.

논문에서는 parameter인 $N, n, c, r, h$를 작게 주더라도 NP-complete임이 보여진다고 했습니다. 논문에서의 분석은 다음과 같습니다:

| Case       | Approach            |    Running Time     |
| ---------- | ------------------- | :-----------------: |
| $r=1$      | Greedy              |    $O(N)=O(cn)$     |
| $c=1$      | Lazy                |   $O(N+n \log h)$   |
| General    | Dynamic Programming | $O(Nhc^hn^{h+c-1})$ |
| $h=2, r=2$ | NP-complete         |          -          |

다음으로는 $r=1$, 즉 모든 카드가 한번씩만 나타나는 Unique Appearance case와 $c=1$, 즉 색이 하나뿐인 One Color case에 대해 간단하게 다루어보겠습니다.

---

[^a]: 기본 전략에 대해서도 다루고 싶지만, 나중에 천천히 다루어 보도록 하겠습니다. 특히 [^2]를 다룰 일이 있다면요.
[^b]: 이런 선 플레이어, 결정법을 개인적으로 좋아합니다. 재밌잖아요!
[^c]: 원래 룰과 동일합니다.
[^d]: 논문에 언급되어있지는 않지만, $\forall a_i \in \{1,\dots,n\}, \forall k_i \in \{1,\dots,c\}, (a_i, k_i) \in \sigma$가 가정되는듯 합니다. 이후 NP-completeness 증명에서 Reduction을 할 때 고의로 카드를 빼먹는 경우가 발생할 수 있겠지만, 이에 대한 분석을 아직 하지 못한 상태입니다.
[^1]: J. Baffier et al., 2017, *Hanabi is NP-hard, Even for Cheaters who Look at Their Cards*, [arXiv:1603.01911 [cs.DM]](https://arxiv.org/abs/1603.01911)
[^2]: B. Bouzy, 2017, *Playing Hanabi Near-Optimally*, http://helios.mi.parisdescartes.fr/~bouzy/publications/bouzy-hanabi-2017.pdf